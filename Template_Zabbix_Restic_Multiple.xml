<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
    <version>7.4</version>
    <template_groups>
        <template_group>
            <uuid>846977d1dfed4968bc5f8bdb363285bc</uuid>
            <name>Templates/Operating systems</name>
        </template_group>
    </template_groups>
    <templates>
        <template>
            <uuid>07065ad7dc4846098587d1b12a7cdedd</uuid>
            <template>restic backup multiple by Zabbix agent</template>
            <name>restic backup multiple by Zabbix agent</name>
            <description>## Overview

Get alerts when your restic backup have failed, or didn't finish on time. The default is in last 26 hours but can be changed via a MACRO.
 
Two MACROs are available:
* `{$BACKUP_STATUS_FILE}` which contain the full path of the status file. Default is `/home/backup/status.json`.
* `{$MAX_HOURS_BETWEEN}` which contain the maximum number of hours before it triggers an alert. Default is `26` hours (for backup running once a day, plus some time if it takes a bit longer than usual).


 This is using the status file generated by [resticprofile](https://github.com/creativeprojects/resticprofile/).
 
For more information, see the [README](https://github.com/creativeprojects/resticprofile/tree/master/contrib/zabbix).</description>
            <groups>
                <group>
                    <name>Templates/Operating systems</name>
                </group>
            </groups>
            <items>
                <item>
                    <uuid>f304d9cbf4d0457a94fd11eae96d6354</uuid>
                    <name>Restic status file</name>
                    <key>vfs.file.contents[{$BACKUP_STATUS_FILE}]</key>
                    <delay>1h</delay>
                    <history>90d</history>
                    <value_type>TEXT</value_type>
                    <description>Get JSON restic status file generated by restic backup command. e.g.

restic --json --quiet backup /folder | jq -c '. + {profile: &quot;local&quot;}' &gt; /var/log/restic_backup.log

Error result:
{&quot;message_type&quot;:&quot;exit_error&quot;,&quot;code&quot;:1,&quot;message&quot;:&quot;Fatal: all source directories/files do not exist&quot;}</description>
                    <preprocessing>
                        <step>
                            <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                            <parameters>
                                <parameter>1d</parameter>
                            </parameters>
                        </step>
                        <step>
                            <type>JAVASCRIPT</type>
                            <parameters>
                                <parameter>var output = [];
try {
  var backups = JSON.parse(value);
  for (var key in backups) {
    var entry = backups[key];
    if (typeof(entry == &quot;object&quot;)) {
      entry.profile = key;
      output.push(entry);
    }
  }

  /*
  var lines = value.split('\n');
  for (var i = 0; i &lt; lines.length; i++) {
    output.push(JSON.parse(lines[i]));
  }
  */
  return JSON.stringify(output);
} catch(Err) {
   return value;
}</parameter>
                            </parameters>
                        </step>
                    </preprocessing>
                    <tags>
                        <tag>
                            <tag>application</tag>
                            <value>restic</value>
                        </tag>
                    </tags>
                </item>
            </items>
            <discovery_rules>
                <discovery_rule>
                    <uuid>64247957696c41bfb10867332c15472f</uuid>
                    <name>Restic log profiles</name>
                    <type>DEPENDENT</type>
                    <key>backup.results</key>
                    <enabled_lifetime_type>DISABLE_NEVER</enabled_lifetime_type>
                    <item_prototypes>
                        <item_prototype>
                            <uuid>0a80ab2a888b4581bdc61ce5e6be61b6</uuid>
                            <name>Restic profile {#PROFILENAME} time end</name>
                            <type>DEPENDENT</type>
                            <key>restic.backup_end[{#PROFILENAME}]</key>
                            <units>unixtime</units>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <parameters>
                                        <parameter>$[?(@.profile == &quot;{#PROFILENAME}&quot;)].backup_end.first()</parameter>
                                    </parameters>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>JAVASCRIPT</type>
                                    <parameters>
                                        <parameter>return Math.round(Date.parse(value)/1000)</parameter>
                                    </parameters>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>vfs.file.contents[{$BACKUP_STATUS_FILE}]</key>
                            </master_item>
                            <tags>
                                <tag>
                                    <tag>application</tag>
                                    <value>restic</value>
                                </tag>
                            </tags>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <uuid>61e909042f7c48f0bee9b04941e6e58c</uuid>
                                    <expression>now()-last(/restic backup multiple by Zabbix agent/restic.backup_end[{#PROFILENAME}])&gt;({$MAX_HOURS_BETWEEN}*3600)</expression>
                                    <name>Restic last {#PROFILENAME} did not run</name>
                                    <priority>HIGH</priority>
                                    <description>Last profile has not finished on time (or has not started):
last run finished more than {$MAX_HOURS_BETWEEN} hour(s) ago</description>
                                    <manual_close>YES</manual_close>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                        <item_prototype>
                            <uuid>076bd9e13574480fb0dd53dd16aa5589</uuid>
                            <name>Restic profile {#PROFILENAME} time start</name>
                            <type>DEPENDENT</type>
                            <key>restic.backup_start[{#PROFILENAME}]</key>
                            <units>unixtime</units>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <parameters>
                                        <parameter>$[?(@.profile == &quot;{#PROFILENAME}&quot;)].backup_start.first()</parameter>
                                    </parameters>
                                </step>
                                <step>
                                    <type>JAVASCRIPT</type>
                                    <parameters>
                                        <parameter>return Math.round(Date.parse(value)/1000)</parameter>
                                    </parameters>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>vfs.file.contents[{$BACKUP_STATUS_FILE}]</key>
                            </master_item>
                            <tags>
                                <tag>
                                    <tag>application</tag>
                                    <value>restic</value>
                                </tag>
                            </tags>
                        </item_prototype>
                        <item_prototype>
                            <uuid>5900d4086c1c47118a58954e9b4ca9e7</uuid>
                            <name>Restic profile {#PROFILENAME} data added</name>
                            <type>DEPENDENT</type>
                            <key>restic.data_added[{#PROFILENAME}]</key>
                            <units>b</units>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <parameters>
                                        <parameter>$[?(@.profile == &quot;{#PROFILENAME}&quot;)].data_added.first()</parameter>
                                    </parameters>
                                    <error_handler>CUSTOM_VALUE</error_handler>
                                    <error_handler_params>0</error_handler_params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>vfs.file.contents[{$BACKUP_STATUS_FILE}]</key>
                            </master_item>
                            <tags>
                                <tag>
                                    <tag>application</tag>
                                    <value>restic</value>
                                </tag>
                            </tags>
                        </item_prototype>
                        <item_prototype>
                            <uuid>d1b81f966d624e7ab3b6c0cd0dfb7cd9</uuid>
                            <name>Restic profile {#PROFILENAME} data added packed</name>
                            <type>DEPENDENT</type>
                            <key>restic.data_added_packed[{#PROFILENAME}]</key>
                            <units>b</units>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <parameters>
                                        <parameter>$[?(@.profile == &quot;{#PROFILENAME}&quot;)].data_added_packed.first()</parameter>
                                    </parameters>
                                    <error_handler>CUSTOM_VALUE</error_handler>
                                    <error_handler_params>0</error_handler_params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>vfs.file.contents[{$BACKUP_STATUS_FILE}]</key>
                            </master_item>
                            <tags>
                                <tag>
                                    <tag>application</tag>
                                    <value>restic</value>
                                </tag>
                            </tags>
                        </item_prototype>
                        <item_prototype>
                            <uuid>e1fc889a79744ae9967c6f08551505a8</uuid>
                            <name>Restic profile {#PROFILENAME} error</name>
                            <type>DEPENDENT</type>
                            <key>restic.error_message[{#PROFILENAME}]</key>
                            <value_type>CHAR</value_type>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <parameters>
                                        <parameter>$[?(@.profile == &quot;{#PROFILENAME}&quot;)].message.first()</parameter>
                                    </parameters>
                                    <error_handler>CUSTOM_VALUE</error_handler>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>vfs.file.contents[{$BACKUP_STATUS_FILE}]</key>
                            </master_item>
                            <tags>
                                <tag>
                                    <tag>application</tag>
                                    <value>restic</value>
                                </tag>
                            </tags>
                        </item_prototype>
                        <item_prototype>
                            <uuid>7977ffc6eb6c47faac7c199b6b8943b1</uuid>
                            <name>Restic profile {#PROFILENAME} total files processed</name>
                            <type>DEPENDENT</type>
                            <key>restic.filesprocessed[{#PROFILENAME}]</key>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <parameters>
                                        <parameter>$[?(@.profile == &quot;{#PROFILENAME}&quot;)].total_files_processed.first()</parameter>
                                    </parameters>
                                    <error_handler>CUSTOM_VALUE</error_handler>
                                    <error_handler_params>0</error_handler_params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>vfs.file.contents[{$BACKUP_STATUS_FILE}]</key>
                            </master_item>
                            <tags>
                                <tag>
                                    <tag>application</tag>
                                    <value>restic</value>
                                </tag>
                            </tags>
                        </item_prototype>
                        <item_prototype>
                            <uuid>8a998301486a4aee806f6b78cdff46e4</uuid>
                            <name>Restic profile {#PROFILENAME} result</name>
                            <type>DEPENDENT</type>
                            <key>restic.result[{#PROFILENAME}]</key>
                            <value_type>CHAR</value_type>
                            <valuemap>
                                <name>Restic result</name>
                            </valuemap>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <parameters>
                                        <parameter>$[?(@.profile == &quot;{#PROFILENAME}&quot;)].message_type.first()</parameter>
                                    </parameters>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>vfs.file.contents[{$BACKUP_STATUS_FILE}]</key>
                            </master_item>
                            <tags>
                                <tag>
                                    <tag>application</tag>
                                    <value>restic</value>
                                </tag>
                            </tags>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <uuid>76baa76cbba341d386d6337d27195c29</uuid>
                                    <expression>last(/restic backup multiple by Zabbix agent/restic.result[{#PROFILENAME}])=&quot;exit_error&quot;</expression>
                                    <name>Restic last {#PROFILENAME} failed</name>
                                    <priority>HIGH</priority>
                                    <manual_close>YES</manual_close>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                        <item_prototype>
                            <uuid>32525f54291345faaa5899dea63ade1f</uuid>
                            <name>Restic profile {#PROFILENAME} data processed</name>
                            <type>DEPENDENT</type>
                            <key>restic.total_bytes_processed[{#PROFILENAME}]</key>
                            <units>b</units>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <parameters>
                                        <parameter>$[?(@.profile == &quot;{#PROFILENAME}&quot;)].total_bytes_processed.first()</parameter>
                                    </parameters>
                                    <error_handler>CUSTOM_VALUE</error_handler>
                                    <error_handler_params>0</error_handler_params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>vfs.file.contents[{$BACKUP_STATUS_FILE}]</key>
                            </master_item>
                            <tags>
                                <tag>
                                    <tag>application</tag>
                                    <value>restic</value>
                                </tag>
                            </tags>
                        </item_prototype>
                        <item_prototype>
                            <uuid>80025dcb2e214763a33fe8d5b9d53698</uuid>
                            <name>Restic profile {#PROFILENAME} total duration</name>
                            <type>DEPENDENT</type>
                            <key>restic.total_duration[{#PROFILENAME}]</key>
                            <value_type>FLOAT</value_type>
                            <units>s</units>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <parameters>
                                        <parameter>$[?(@.profile == &quot;{#PROFILENAME}&quot;)].total_duration.first()</parameter>
                                    </parameters>
                                    <error_handler>CUSTOM_VALUE</error_handler>
                                    <error_handler_params>0</error_handler_params>
                                </step>
                                <step>
                                    <type>JAVASCRIPT</type>
                                    <parameters>
                                        <parameter>return Math.round(value);</parameter>
                                    </parameters>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>vfs.file.contents[{$BACKUP_STATUS_FILE}]</key>
                            </master_item>
                            <tags>
                                <tag>
                                    <tag>application</tag>
                                    <value>restic</value>
                                </tag>
                            </tags>
                        </item_prototype>
                    </item_prototypes>
                    <master_item>
                        <key>vfs.file.contents[{$BACKUP_STATUS_FILE}]</key>
                    </master_item>
                    <lld_macro_paths>
                        <lld_macro_path>
                            <lld_macro>{#PROFILENAME}</lld_macro>
                            <path>$.profile</path>
                        </lld_macro_path>
                    </lld_macro_paths>
                </discovery_rule>
            </discovery_rules>
            <tags>
                <tag>
                    <tag>from</tag>
                    <value>local</value>
                </tag>
            </tags>
            <macros>
                <macro>
                    <macro>{$BACKUP_STATUS_FILE}</macro>
                    <value>/var/log/restic_backup.log</value>
                    <description>Restic status file</description>
                </macro>
                <macro>
                    <macro>{$MAX_HOURS_BETWEEN}</macro>
                    <value>26</value>
                </macro>
            </macros>
            <valuemaps>
                <valuemap>
                    <uuid>6e756aa48455489b8d037d07e6ef9c35</uuid>
                    <name>Restic result</name>
                    <mappings>
                        <mapping>
                            <value>summary</value>
                            <newvalue>Success</newvalue>
                        </mapping>
                        <mapping>
                            <value>exit_error</value>
                            <newvalue>Failure</newvalue>
                        </mapping>
                    </mappings>
                </valuemap>
            </valuemaps>
        </template>
    </templates>
</zabbix_export>
